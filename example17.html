<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>스택형 막대 차트 (화이트 배경)</title>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      background-color: #ffffff;
      color: #000000;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    #chart {
      /* 중요한 부분: 반응형으로 폭이 줄어들 수 있게 100% 설정 */
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="chart"></div>

  <script>
    function decodeBase64(base64String) {
      const decodedString = atob(base64String);
      return JSON.parse(decodedString);
    }

    fetch('17.json')
      .then(response => response.text())
      .then(base64Data => {
        const data = decodeBase64(base64Data);

        const allDates = [...new Set(data.map(item => item.date))]
          .sort((a, b) => new Date(a) - new Date(b));

        const actions = [
          'bitcoin', 'ethereum', 'sui', 'solana',
          'sei', 'bnb', 'cardano'
        ];

        const series = actions.map(action => {
          return {
            name: action,
            data: allDates.map(date => {
              const entries = data.filter(item => item.date === date);
              const total = entries.reduce((sum, item) => sum + item.count, 0);
              const entry = entries.find(item => item.action === action);
              return entry ? (entry.count / total) * 100 : 0;
            })
          };
        });

        // 차트 기본 옵션
        const options = {
          chart: {
            type: 'bar',
            height: '100%',
            width: '100%',
            stacked: true,
            stackType: '100%',
            background: '#ffffff',
            toolbar: { tools: { download: false } }
          },
          series: series,
          xaxis: {
            categories: allDates,  // 처음에는 full categories
            tickAmount: 6,         // 데스크톱 기본 6개
            labels: {
              rotate: 0,
              showDuplicates: false,
              hideOverlappingLabels: true,
              trim: false,
              style: { fontSize: '12px', colors: '#000000' }
            }
          },
          yaxis: {
            labels: {
              formatter: val => val.toFixed(0) + '%',
              style: { colors: '#000000' }
            }
          },
          colors: [
            '#FFD700', '#87CEEB', '#FF69B4',
            '#32CD32', '#FFA07A', '#BA55D3', '#20B2AA'
          ],
          tooltip: {
            enabled: true,
            shared: true,
            followCursor: true,
            intersect: false,
            y: {
              formatter: val => val.toFixed(2) + '%'
            },
            theme: 'light',
            style: { fontSize: '16px' }
          },
          fill: { opacity: 1 },
          legend: {
            position: 'bottom',
            offsetY: 0,
            labels: { colors: '#000000' }
          },
          dataLabels: { enabled: false },
          grid: {
            borderColor: '#cccccc',
            xaxis: { lines: { show: true } },
            yaxis: { lines: { show: true } }
          },
          // 반응형 설정
          responsive: [
            {
              breakpoint: 480,
              options: {
                xaxis: {
                  // categories 배열을 2개만 남긴 배열로 교체
                  categories: allDates.slice(0, 2),
                  tickAmount: 2,
                  labels: {
                    hideOverlappingLabels: false, // 2개면 겹칠 일이 거의 없으니 false
                  }
                }
              }
            }
          ]
        };

        const chart = new ApexCharts(document.querySelector('#chart'), options);
        chart.render();
      })
      .catch(error => console.error('오류 발생:', error));
  </script>
</body>
</html>
