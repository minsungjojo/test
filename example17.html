<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>스택형 막대 차트 (Datetime 축)</title>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    /* 차트 컨테이너를 반응형으로 설정해야, 브라우저 크기 변화에 따라 x축 라벨도 자동 조정됨 */
    html, body {
      margin: 0; 
      padding: 0;
      height: 100%;
      background-color: #ffffff;
      color: #000000;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    #chart {
      width: 100%;  /* 부모 폭에 맞춰 가로 100% */
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="chart"></div>

  <script>
    // Base64 디코딩 함수
    function decodeBase64(base64String) {
      const decodedString = atob(base64String);
      return JSON.parse(decodedString);
    }

    // Base64로 암호화된 JSON 데이터를 가져옵니다
    fetch('17.json') // Base64로 암호화된 JSON 파일 경로
      .then(response => response.text())
      .then(base64Data => {
        const rawData = decodeBase64(base64Data);

        // 1) 날짜 목록 추출 & 정렬
        const uniqueDates = [...new Set(rawData.map(item => item.date))].sort(
          (a, b) => new Date(a) - new Date(b)
        );

        // 2) 코인(action) 목록
        const actions = [
          'bitcoin',
          'ethereum',
          'sui',
          'solana',
          'sei',
          'bnb',
          'cardano'
        ];

        // 3) 각 날짜별 합계를 미리 계산 (전체 건수)
        //    예: totalsByDate["2023-01-01"] = 120
        const totalsByDate = {};
        uniqueDates.forEach(date => {
          const items = rawData.filter(d => d.date === date);
          const sum = items.reduce((acc, obj) => acc + obj.count, 0);
          totalsByDate[date] = sum;
        });

        // 4) series = actions.map(...) => [ { name, data: [ { x, y }, ... ] }, ...]
        //    스택형 '100%' 막대차트이므로 y에는 "전체 대비 퍼센트" 값을 넣습니다.
        const series = actions.map(actionName => {
          // 4.1) 각 action에 대한 날짜별 (x, y) 배열 생성
          const dataPoints = uniqueDates.map(date => {
            // rawData 중에서 해당 날짜 & action에 해당하는 값 찾기
            const found = rawData.find(
              item => item.date === date && item.action === actionName
            );
            // 퍼센트 계산
            const total = totalsByDate[date] || 0;
            const count = found ? found.count : 0;
            const percentage = total > 0 ? (count / total) * 100 : 0;

            return {
              x: date,     // ApexCharts가 'YYYY-MM-DD' 문자열을 날짜로 인식 (type: 'datetime') 
              y: percentage
            };
          });

          return {
            name: actionName,
            data: dataPoints
          };
        });

        // 5) 차트 옵션
        const options = {
          chart: {
            type: 'bar',
            height: '100%',
            width: '100%',
            stacked: true,
            stackType: '100%',    // 각 x(날짜)에 대해 합계를 100%로 맞춤
            background: '#ffffff', 
            toolbar: {
              tools: {
                download: false   // 다운로드 버튼 비활성화
              }
            }
          },
          series: series,

          // xaxis를 날짜 축(datetime)으로 설정
          xaxis: {
            type: 'datetime',
            // tickAmount 설정을 생략하면, ApexCharts가 화면 크기에 따라 라벨 간격을 자동 계산
            // tickAmount: 6, // (원한다면 최대 표시 라벨 수를 제한 가능)
            labels: {
              rotate: 0,               // 0도로 표시 (수평)
              hideOverlappingLabels: true, // 겹치면 일부 라벨 숨김
              trim: false,            // '...'으로 생략하지 않음
              style: {
                fontSize: '12px',
                colors: '#000000'
              }
            }
          },
          yaxis: {
            labels: {
              formatter: val => val.toFixed(0) + '%',  // 퍼센트로 표시
              style: { colors: '#000000' }
            }
          },
          colors: [
            '#FFD700',
            '#87CEEB',
            '#FF69B4',
            '#32CD32',
            '#FFA07A',
            '#BA55D3',
            '#20B2AA'
          ],
          tooltip: {
            enabled: true,
            shared: true,
            followCursor: true,
            intersect: false,
            y: {
              formatter: val => val.toFixed(2) + '%'
            },
            theme: 'light',
            style: {
              fontSize: '16px'
            },
            marker: {
              // 시리즈별 색상과 동일하게
              fillColors: [
                '#FFD700',
                '#87CEEB',
                '#FF69B4',
                '#32CD32',
                '#FFA07A',
                '#BA55D3',
                '#20B2AA'
              ]
            }
          },
          fill: {
            opacity: 1
          },
          legend: {
            position: 'bottom', // 범례를 아래로
            labels: {
              colors: '#000000'
            }
          },
          dataLabels: {
            enabled: false
          },
          grid: {
            borderColor: '#cccccc',
            xaxis: { lines: { show: true } },
            yaxis: { lines: { show: true } }
          }
        };

        // 6) 차트 생성 및 렌더링
        const chart = new ApexCharts(document.querySelector('#chart'), options);
        chart.render();
      })
      .catch(error => console.error('데이터를 가져오는 중 오류가 발생했습니다:', error));
  </script>
</body>
</html>
